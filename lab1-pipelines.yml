# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  name: Local-Windows 

stages:
- stage: Build
  displayName: 'Copy files from GitHub an publish artifact file'
  pool: Local-Windows
  jobs:
  - job: 'Copyfiles' 
    steps:
    - task: CopyFiles@2
      displayName: 'Copy Files from GitHub to Pipeline staging folder'
      inputs:
        SourceFolder: '$(system.defaultworkingdirectory)'
        Contents: '**\db-ronaldo-correa.dacpac'
        TargetFolder: '$(build.artifactstagingdirectory)'
      condition: succeededOrFailed()

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        PathtoPublish: '$(build.artifactstagingdirectory)'
      condition: succeededOrFailed()

- stage: CD
  displayName: CD stage
  jobs:  
  - deployment: VMDeploy
    displayName: mssql1
    environment:
      name:  Local-Windows-SQL
      resourceType: VirtualMachine
      tags: winsql
    strategy:
      runOnce:
        deploy:
          steps:
          - download: none

          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: current
              downloadType: single
              downloadPath: $(System.DefaultWorkingDirectory)
              artifactName: 'drop'

          - task: SqlDacpacDeploymentOnMachineGroup@0
            displayName: 'Deploy using : dacpac db-ronaldo-correa'
            inputs:
                tasktype: 'dacpac'
                DacpacFile: '$(System.DefaultWorkingDirectory)/drop/db-ronaldo-correa.dacpac'
                TargetMethod: 'server'
                ServerName: 'localhost'
                DatabaseName: 'db-ronaldo-correa'
                AuthScheme: sqlServerAuthentication
                SqlUsername: 'sa'
                SqlPassword: '$(sql-dev-password)'
